<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="HandheldFriendly" content="true">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Используем ab для тестирования производительности web-приложения</title>
    <link rel="stylesheet" href="/theme/css/native.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/main.css" />
    <link href="https://fonts.googleapis.com/css?family=PT+Serif&amp;subset=cyrillic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=PT+Mono&amp;subset=cyrillic" rel="stylesheet">
    <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-20497524-1', 'auto');
      ga('send', 'pageview');
    </script>
	
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  "HTML-CSS": {
  styles: {
  ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
  },
  tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']],processEscapes: true}
  });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body id="index" class="home">
        <header id="banner" class="body">
            <h1><a href="/en/">Tech blog by @dizballanze <strong></strong></a></h1>
            <div id="langs">
                <a href="/">En</a>
                <a href="/ru/">Ru</a>
            </div>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/en/about-me/">Author</a></li>
            <li><a href="https://wbtech.pro/">WB–Tech</a></li>
            <li><a href="https://debugmail.io/">DebugMail</a></li>
        </ul>
        </nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="/en/drafts/ispolzuem-ab-dlia-testirovaniia-proizvoditelnosti-web-prilozheniia-ru.html" rel="bookmark"
         title="Permalink to Используем ab для тестирования производительности web-приложения">Используем ab для тестирования производительности web-приложения</a></h2>
    <time class="published" datetime="2012-03-14T01:27:00+04:00"><nobr>14 мар 2012</nobr></time>
  </header>
  <div class="entry-content">
    <p>Важной частью разработки web-приложения является тестирование
производительности. Часто при постановке задачи заказчик требует чтобы
сервис выдерживал определенную нагрузку. В процессе профилирования и
оптимизации полезно отслеживать, как изменилась скорость работы
приложения при новых условиях. Для этой цели можно использовать Apache
HTTP server benchmarking tool.</p>
<h2 id="ispolzovanie-ab">Использование ab</h2>
<h3 id="ustanovka">Установка</h3>
<p>Для того чтобы установить ab в debian необходимо установить пакет
apache2-utils:</p>
<div class="highlight"><pre><span></span>apt-get install apache2-utils
</pre></div>
<h3 id="parametry">Параметры</h3>
<p>Утилита запускается с помощью команды ab. Далее рассмотрим основные
параметры.</p>
<ul>
<li><strong>-c</strong> - очень важный параметр. Определяет количество параллельных
    запросов отправляемых одновременно</li>
<li><strong>-n</strong> - количество отправляемых запросов</li>
<li><strong>-t</strong> - максимальное количество секунд отведенное на тест. Подходит
    для тестирования приложения в течении определенного временного
    промежутка. При этому необходимо задать большое значение параметру
    -n</li>
<li><strong>-C</strong> cookie-name=value - добавляем cookie в каждый запрос к
    серверу</li>
<li><strong>-H</strong> - задаем заголовок запроса</li>
<li><strong>-T</strong> - Content-type заголовок запроса</li>
<li><strong>-p</strong> - файл содержащий тело POST запроса</li>
</ul>
<p>Выполнение теста</p>
<p>Давайте выполним тестирование какого-либо сайта и рассмотрим содержание
отчета, который генерирует ab.</p>
<div class="highlight"><pre><span></span>ab -c <span class="m">10</span> -n <span class="m">100</span> http://google.com/
Benchmarking google.com <span class="o">(</span>be patient<span class="o">)</span>.....done


Server Software:        gws
Server Hostname:        google.com
Server Port:            <span class="m">80</span>

Document Path:          /
Document Length:        <span class="m">219</span> bytes

Concurrency Level:      <span class="m">10</span>
Time taken <span class="k">for</span> tests:   <span class="m">1</span>.290 seconds
Complete requests:      <span class="m">100</span>
Failed requests:        <span class="m">0</span>
Write errors:           <span class="m">0</span>
Non-2xx responses:      <span class="m">100</span>
Total transferred:      <span class="m">54000</span> bytes
HTML transferred:       <span class="m">21900</span> bytes
Requests per second:    <span class="m">77</span>.51 <span class="o">[</span><span class="c1">#/sec] (mean)</span>
Time per request:       <span class="m">129</span>.018 <span class="o">[</span>ms<span class="o">]</span> <span class="o">(</span>mean<span class="o">)</span>
Time per request:       <span class="m">12</span>.902 <span class="o">[</span>ms<span class="o">]</span> <span class="o">(</span>mean, across all concurrent requests<span class="o">)</span>
Transfer rate:          <span class="m">40</span>.87 <span class="o">[</span>Kbytes/sec<span class="o">]</span> received

Connection Times <span class="o">(</span>ms<span class="o">)</span>
              min  mean<span class="o">[</span>+/-sd<span class="o">]</span> median   max
Connect:       <span class="m">54</span>   <span class="m">56</span>   <span class="m">2</span>.0     <span class="m">55</span>      <span class="m">63</span>
Processing:    <span class="m">70</span>   <span class="m">72</span>   <span class="m">2</span>.4     <span class="m">72</span>      <span class="m">82</span>
Waiting:       <span class="m">70</span>   <span class="m">72</span>   <span class="m">2</span>.3     <span class="m">72</span>      <span class="m">82</span>
Total:        <span class="m">124</span>  <span class="m">128</span>   <span class="m">3</span>.4    <span class="m">127</span>     <span class="m">140</span>

Percentage of the requests served within a certain <span class="nb">time</span> <span class="o">(</span>ms<span class="o">)</span>
  <span class="m">50</span>%    <span class="m">127</span>
  <span class="m">66</span>%    <span class="m">128</span>
  <span class="m">75</span>%    <span class="m">129</span>
  <span class="m">80</span>%    <span class="m">130</span>
  <span class="m">90</span>%    <span class="m">133</span>
  <span class="m">95</span>%    <span class="m">134</span>
  <span class="m">98</span>%    <span class="m">138</span>
  <span class="m">99</span>%    <span class="m">140</span>
 <span class="m">100</span>%    <span class="m">140</span> <span class="o">(</span>longest request<span class="o">)</span>
</pre></div>
<p>Сначала выводится различная информация о проводимом тесте, такая как
типа серверного ПО, хост, порт, путь и тд. Дальше идут более интересные
характеристики. Рассмотрим наиболее важные из них:</p>
<ul>
<li><strong>Time taken for tests</strong> - суммарное время потраченное на весь тест</li>
<li><strong>Complete requests</strong> - количество выполненных запросов</li>
<li><strong>Failed requests</strong> - количество запросов завершенных отказом</li>
<li><strong>Total transferred и HTML transferred</strong> - суммарный объем и объем
    html переданные во время теста</li>
<li><strong>Requests per second</strong> или <strong>rps</strong> - количество обрабатываемых
    запросов в секунду</li>
<li><strong>Time per request</strong> - среднее время затраченное на запрос с и без
    учета распараллеливания</li>
<li><strong>Transfer rate</strong> - скорость передачи данных при прохождении теста</li>
</ul>
<p>Далее идет таблица с временем затраченным на подключение, обработку
запроса и ожидание. И после этого таблица которая показывает процент от
количества запросов, которые успели выполнится за определенный
промежуток времени.</p>
<h2 id="prakticheskoe-primenenie_2">Практическое применение</h2>
<p>В зависимости от поставленных перед вами задач необходимо задавать
различные параметры при запуске теста. Рассмотрим несколько примеров.</p>
<ul>
<li><strong>Нагрузочное тестирование</strong>. Тестирование системы при заданной
    нагрузке. Здесь все просто - указываем заданные значения для
    параметров -n и -c и запускаем тест. В результате необходимо
    выяснить загруженность аппаратной части приложения, надёжность
    работы (количество отказов за заданное время).</li>
<li><strong>Стресс-тестирование</strong>. Определение максимальной нагрузки при
    которой сервер остается работоспособным, а также выявление
    последствий нагрузки превышающей ожидаемую. В данном случае вам
    необходимо выполнить несколько итераций запуска тестов, постепенно
    наращивая количество параллельных запросов и количество пакетов.
    Данный цикл необходимо продолжать пока вы не начнете получать
    значительный для вас процент отказов (или не положите сервер ;)).
    Наиболее важными, на мой взгляд, в данном случае являются такие
    показатели, как количество запросов в секунду и время потраченное на
    1 запрос, а также процент отказов.</li>
<li><strong>Тестирование стабильности</strong>. При данном виде тестирования мы
    производим длительный тест (время задаем при помощи параметра -t, а
    количество запросов -n очень большое) и смотрим количество отказов
    системы. Также полезным будет ознакомится с "разбросом" времени
    обработки запроса, для того чтобы выяснить не ухудшается ли
    производительность со временем. Данное значение можно получить из
    таблицы Connection Times.</li>
</ul>
<h2 id="dopolnitelno-primer-vypolneniia-post-zaprosa-v-ab">Дополнительно. Пример выполнения POST-запроса в ab</h2>
<p>Для выполнения POST-запроса необходимо составить тело запроса и
сохранить его в файл. Для этого напишем небольшой скрипт:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'test1'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'test2'</span> <span class="o">=&gt;</span> <span class="s1">'Second test'</span><span class="p">);</span>
<span class="nv">$body</span> <span class="o">=</span> <span class="nb">http_build_query</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
<span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'/tmp/body'</span><span class="p">,</span> <span class="nv">$body</span><span class="p">);</span>
</pre></div>
<p>После этого в файле /tmp/body появится следующее содержимое:</p>
<div class="highlight"><pre><span></span>test1=1&amp;test2=Second+test
</pre></div>
<p>Теперь можно запускать тестирование:</p>
<div class="highlight"><pre><span></span>ab -T application/x-www-form-urlencoded -p /tmp/body -n <span class="m">10</span> http://localhost/test/ab/post-handler.php
</pre></div>
<h2 id="vyvod">Вывод</h2>
<p>Apache HTTP server benchmarking tool - полезный инструмент
web-разработчика, который позволяет максимально быстро произвести
тестирование производительности той или иной части приложения. Он
отлично подходит для тестирования критических участков и является
незаменимым при профилировании и оптимизации web-приложения. Однако для
тестирования нескольких функций с учетом различных сценариев и
моделирования действий пользователя, необходимо использовать более
сложные системы тестирования.</p>
<h3 id="update-1">UPDATE #1</h3>
<p>Полезное дополнение от товарища:</p>
<blockquote>
<p>ApacheBenchmark выдает много Failed. Сначала было стремно, но все
оказалось не так страшно :) [#apache][]
<a href="http://t.co/tZSKksDl" title="http://stackoverflow.com/questions/579450/load-testing-with-ab-fake-failed-requests-length">stackoverflow.com/questions/5794&hellip;</a></p>
<p>&mdash; Pugach Vitaliy (@lionasp) <a href="https://twitter.com/lionasp/status/180726351786020865">March 16, 2012</a></p>
</blockquote>
  </div>
</section>
        <footer id="contentinfo" class="body">
            (c) 2010-2017
        </footer><!-- /#contentinfo -->
</body>
</html>