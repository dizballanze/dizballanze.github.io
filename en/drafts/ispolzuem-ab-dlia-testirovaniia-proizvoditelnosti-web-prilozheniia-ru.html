<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="HandheldFriendly" content="true">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Используем ab для тестирования производительности web-приложения</title>
    <link rel="stylesheet" href="/theme/css/native.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/main.css" />
    <link href="https://fonts.googleapis.com/css?family=PT+Serif&amp;subset=cyrillic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=PT+Mono&amp;subset=cyrillic" rel="stylesheet">
    <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-20497524-1', 'auto');
      ga('send', 'pageview');
    </script>
	
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  "HTML-CSS": {
  styles: {
  ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
  },
  tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']],processEscapes: true}
  });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body id="index" class="home">
        <header id="banner" class="body">
            <h1><a href="/en/">Tech blog by @dizballanze <strong></strong></a></h1>
            <div id="langs">
                <a href="/">En</a>
                <a href="/ru/">Ru</a>
            </div>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/en/about-me/">Author</a></li>
            <li><a href="https://wbtech.pro/">WB–Tech</a></li>
            <li><a href="https://debugmail.io/">DebugMail</a></li>
        </ul>
        </nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="/en/drafts/ispolzuem-ab-dlia-testirovaniia-proizvoditelnosti-web-prilozheniia-ru.html" rel="bookmark"
         title="Permalink to Используем ab для тестирования производительности web-приложения">Используем ab для тестирования производительности web-приложения</a></h2>
    <time class="published" datetime="2012-03-14T01:27:00+04:00"><nobr>14 мар 2012</nobr></time>
  </header>
  <div class="entry-content">
    <p>Важной частью разработки web-приложения является тестирование
производительности. Часто при постановке задачи заказчик требует чтобы
сервис выдерживал определенную нагрузку. В процессе профилирования и
оптимизации полезно отслеживать, как изменилась скорость работы
приложения при новых условиях. Для этой цели можно использовать Apache
HTTP server benchmarking tool.</p>
<h2 id="ispolzovanie-ab">Использование ab</h2>
<h3 id="ustanovka">Установка</h3>
<p>Для того чтобы установить ab в debian необходимо установить пакет
apache2-utils:</p>
<pre><code>:::bash
apt-get install apache2-utils
</code></pre>
<h3 id="parametry">Параметры</h3>
<p>Утилита запускается с помощью команды ab. Далее рассмотрим основные
параметры.</p>
<ul>
<li><strong>-c</strong> - очень важный параметр. Определяет количество параллельных
    запросов отправляемых одновременно</li>
<li><strong>-n</strong> - количество отправляемых запросов</li>
<li><strong>-t</strong> - максимальное количество секунд отведенное на тест. Подходит
    для тестирования приложения в течении определенного временного
    промежутка. При этому необходимо задать большое значение параметру
    -n</li>
<li><strong>-C</strong> cookie-name=value - добавляем cookie в каждый запрос к
    серверу</li>
<li><strong>-H</strong> - задаем заголовок запроса</li>
<li><strong>-T</strong> - Content-type заголовок запроса</li>
<li><strong>-p</strong> - файл содержащий тело POST запроса</li>
</ul>
<p>Выполнение теста</p>
<p>Давайте выполним тестирование какого-либо сайта и рассмотрим содержание
отчета, который генерирует ab.</p>
<pre><code>:::bash
ab -c 10 -n 100 http://google.com/
Benchmarking google.com (be patient).....done


Server Software:        gws
Server Hostname:        google.com
Server Port:            80

Document Path:          /
Document Length:        219 bytes

Concurrency Level:      10
Time taken for tests:   1.290 seconds
Complete requests:      100
Failed requests:        0
Write errors:           0
Non-2xx responses:      100
Total transferred:      54000 bytes
HTML transferred:       21900 bytes
Requests per second:    77.51 [#/sec] (mean)
Time per request:       129.018 [ms] (mean)
Time per request:       12.902 [ms] (mean, across all concurrent requests)
Transfer rate:          40.87 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:       54   56   2.0     55      63
Processing:    70   72   2.4     72      82
Waiting:       70   72   2.3     72      82
Total:        124  128   3.4    127     140

Percentage of the requests served within a certain time (ms)
  50%    127
  66%    128
  75%    129
  80%    130
  90%    133
  95%    134
  98%    138
  99%    140
 100%    140 (longest request)
</code></pre>
<p>Сначала выводится различная информация о проводимом тесте, такая как
типа серверного ПО, хост, порт, путь и тд. Дальше идут более интересные
характеристики. Рассмотрим наиболее важные из них:</p>
<ul>
<li><strong>Time taken for tests</strong> - суммарное время потраченное на весь тест</li>
<li><strong>Complete requests</strong> - количество выполненных запросов</li>
<li><strong>Failed requests</strong> - количество запросов завершенных отказом</li>
<li><strong>Total transferred и HTML transferred</strong> - суммарный объем и объем
    html переданные во время теста</li>
<li><strong>Requests per second</strong> или <strong>rps</strong> - количество обрабатываемых
    запросов в секунду</li>
<li><strong>Time per request</strong> - среднее время затраченное на запрос с и без
    учета распараллеливания</li>
<li><strong>Transfer rate</strong> - скорость передачи данных при прохождении теста</li>
</ul>
<p>Далее идет таблица с временем затраченным на подключение, обработку
запроса и ожидание. И после этого таблица которая показывает процент от
количества запросов, которые успели выполнится за определенный
промежуток времени.</p>
<h2 id="prakticheskoe-primenenie_2">Практическое применение</h2>
<p>В зависимости от поставленных перед вами задач необходимо задавать
различные параметры при запуске теста. Рассмотрим несколько примеров.</p>
<ul>
<li><strong>Нагрузочное тестирование</strong>. Тестирование системы при заданной
    нагрузке. Здесь все просто - указываем заданные значения для
    параметров -n и -c и запускаем тест. В результате необходимо
    выяснить загруженность аппаратной части приложения, надёжность
    работы (количество отказов за заданное время).</li>
<li><strong>Стресс-тестирование</strong>. Определение максимальной нагрузки при
    которой сервер остается работоспособным, а также выявление
    последствий нагрузки превышающей ожидаемую. В данном случае вам
    необходимо выполнить несколько итераций запуска тестов, постепенно
    наращивая количество параллельных запросов и количество пакетов.
    Данный цикл необходимо продолжать пока вы не начнете получать
    значительный для вас процент отказов (или не положите сервер ;)).
    Наиболее важными, на мой взгляд, в данном случае являются такие
    показатели, как количество запросов в секунду и время потраченное на
    1 запрос, а также процент отказов.</li>
<li><strong>Тестирование стабильности</strong>. При данном виде тестирования мы
    производим длительный тест (время задаем при помощи параметра -t, а
    количество запросов -n очень большое) и смотрим количество отказов
    системы. Также полезным будет ознакомится с "разбросом" времени
    обработки запроса, для того чтобы выяснить не ухудшается ли
    производительность со временем. Данное значение можно получить из
    таблицы Connection Times.</li>
</ul>
<h2 id="dopolnitelno-primer-vypolneniia-post-zaprosa-v-ab">Дополнительно. Пример выполнения POST-запроса в ab</h2>
<p>Для выполнения POST-запроса необходимо составить тело запроса и
сохранить его в файл. Для этого напишем небольшой скрипт:</p>
<pre><code>:::php
&lt;?php
$params = array('test1' =&gt; 1, 'test2' =&gt; 'Second test');
$body = http_build_query($params);
file_put_contents('/tmp/body', $body);
</code></pre>
<p>После этого в файле /tmp/body появится следующее содержимое:</p>
<pre><code>:::text
test1=1&amp;test2=Second+test
</code></pre>
<p>Теперь можно запускать тестирование:</p>
<pre><code>:::bash
ab -T application/x-www-form-urlencoded -p /tmp/body -n 10 http://localhost/test/ab/post-handler.php
</code></pre>
<h2 id="vyvod">Вывод</h2>
<p>Apache HTTP server benchmarking tool - полезный инструмент
web-разработчика, который позволяет максимально быстро произвести
тестирование производительности той или иной части приложения. Он
отлично подходит для тестирования критических участков и является
незаменимым при профилировании и оптимизации web-приложения. Однако для
тестирования нескольких функций с учетом различных сценариев и
моделирования действий пользователя, необходимо использовать более
сложные системы тестирования.</p>
<h3 id="update-1">UPDATE #1</h3>
<p>Полезное дополнение от товарища:</p>
<blockquote>
<p>ApacheBenchmark выдает много Failed. Сначала было стремно, но все
оказалось не так страшно :) [#apache][]
<a href="http://t.co/tZSKksDl" title="http://stackoverflow.com/questions/579450/load-testing-with-ab-fake-failed-requests-length">stackoverflow.com/questions/5794&hellip;</a></p>
<p>&mdash; Pugach Vitaliy (@lionasp) <a href="https://twitter.com/lionasp/status/180726351786020865">March 16, 2012</a></p>
</blockquote>
  </div>
</section>
        <footer id="contentinfo" class="body">
            (c) 2010-2017
        </footer><!-- /#contentinfo -->
</body>
</html>