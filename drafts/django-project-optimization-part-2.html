<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="HandheldFriendly" content="true">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Django project optimization guide (part 2)</title>
    <link rel="stylesheet" href="/theme/css/native.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/main.css" />
    <link href="https://fonts.googleapis.com/css?family=PT+Serif&amp;subset=cyrillic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=PT+Mono&amp;subset=cyrillic" rel="stylesheet">
    <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-20497524-1', 'auto');
      ga('send', 'pageview');
    </script>
	
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  "HTML-CSS": {
  styles: {
  ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
  },
  tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']],processEscapes: true}
  });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body id="index" class="home">
        <header id="banner" class="body">
            <h1><a href="/">Tech blog by @dizballanze <strong></strong></a></h1>
            <div id="langs">
                <a href="/">En</a>
                <a href="/ru/">Ru</a>
            </div>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/about-me/">Author</a></li>
            <li><a href="https://wbtech.pro/">WBâ€“Tech</a></li>
            <li><a href="https://debugmail.io/">DebugMail</a></li>
        </ul>
        </nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="/drafts/django-project-optimization-part-2.html" rel="bookmark"
         title="Permalink to Django project optimization guide (part 2)">Django project optimization guide (part 2)</a></h2>
    <time class="published" datetime="2017-06-28T11:05:00+03:00"><nobr>28 Jun 2017</nobr></time>
  </header>
  <div class="entry-content">
    <p>This is the second part of Django project optimization series. The first part was about profiling and Django settings, 
it's available <a href="/django-project-optimization-part-1/">here</a>. In this part, I will cover optimization of working
with database (Django models).</p>
<p>We will use SQL logging and Django Debug Toolbar described in the first part of the series. I will use
PostgreSQL in all examples, but most part of this guide will be useful for other databases too.</p>
<p>Examples in this part are based on simple blog application, that we will build and optimize throughout the guide. Let's
begin with the following models:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>


<span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>
    <span class="n">bio</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>


<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Author</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Tag</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
</pre></div>


<p>All code is available on <a href="https://github.com/dizballanze/django-optimization-guide-2-sample/tree/initial">GitHub</a>
with <a href="https://github.com/dizballanze/django-optimization-guide-2-sample/tags">tags</a>.</p>
<h2>Mass edit</h2>
<h3>Mass insertion</h3>
<p>Let's imagine, that our new blog application replaces some old one and we need to transfer data to new models.
We have exported data from old application to the huge JSON files. File with authors have following structure:</p>
<div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;mackchristopher&quot;</span><span class="p">,</span>
    <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;dcortez@yahoo.com&quot;</span><span class="p">,</span>
    <span class="nt">&quot;bio&quot;</span><span class="p">:</span> <span class="s2">&quot;Vitae mollitia in modi suscipit similique. Tempore sunt aliquid porro. Molestias tempora quos corporis quam.&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>


<p>Let's create Django command to import authors from JSON file:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>

    <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Load authors from `data/old_authors.json`&#39;</span>

    <span class="n">DATA_FILE_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;old_data.json&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_FILE_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_import_author</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_import_author</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">author_data</span><span class="p">):</span>
        <span class="n">author</span> <span class="o">=</span> <span class="n">Author</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="n">author_data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
            <span class="n">email</span><span class="o">=</span><span class="n">author_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
            <span class="n">bio</span><span class="o">=</span><span class="n">author_data</span><span class="p">[</span><span class="s1">&#39;bio&#39;</span><span class="p">])</span>
        <span class="n">author</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>Now we will check how many SQL requests performed on importing 200 authors. Run in <code>python manage.py shell</code>:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.core.management</span> <span class="kn">import</span> <span class="n">call_command</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="n">call_command</span><span class="p">(</span><span class="s1">&#39;load_data&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">queries</span><span class="p">))</span>
</pre></div>


<p>This code will print a bunch of SQL requests (because SQL logging is enabled) and in the last line, we will see number <code>200</code>
This means, that for every author we perform separated <code>INSERT</code> SQL request. If you have a large amount of data, this
approach could be very slow. Let's use method <code>bulk_create</code> of <code>Author</code> model manager:</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_FILE_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">author_instances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">author_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_import_author</span><span class="p">(</span><span class="n">author</span><span class="p">))</span>
        <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">author_instances</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_import_author</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">author_data</span><span class="p">):</span>
        <span class="n">author</span> <span class="o">=</span> <span class="n">Author</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="n">author_data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
            <span class="n">email</span><span class="o">=</span><span class="n">author_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
            <span class="n">bio</span><span class="o">=</span><span class="n">author_data</span><span class="p">[</span><span class="s1">&#39;bio&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">author</span>
</pre></div>


<p>This command generates one huge SQL request for all authors.</p>
<blockquote>
<p>If you have a really large amount of data, probably, you will need to break insertion into several SQL requests.
You can use a <code>batch_size</code> argument of the <code>bulk_create</code> method for this.
If we want to insert 200 objects (rows) to a database and provide <code>bulk_size=50</code>, Django will generate 4 requests.</p>
<p>The <code>bulk_size</code> method has several drawbacks, you can read about them in the <a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/#bulk-create">documentation</a>.</p>
</blockquote>
<h3>Mass M2M insertion</h3>
<p>Now we need to import articles and tags. They are available in separate JSON file with following structure:</p>
<div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-06-11&quot;</span><span class="p">,</span>
    <span class="nt">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;nichole52&quot;</span><span class="p">,</span>
    <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;ab&quot;</span><span class="p">,</span>
      <span class="s2">&quot;iure&quot;</span><span class="p">,</span>
      <span class="s2">&quot;iusto&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
    <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>


<p>Let's write another command for this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>

    <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Load articles from `data/old_articles.json`&#39;</span>

    <span class="n">DATA_FILE_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;old_articles.json&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_FILE_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_import_article</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_import_article</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">article_data</span><span class="p">):</span>
        <span class="n">author</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">])</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
            <span class="n">content</span><span class="o">=</span><span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">],</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">],</span>
            <span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">)</span>
        <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]:</span>
            <span class="n">tag_instance</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">article</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag_instance</span><span class="p">)</span>
</pre></div>


<p>After running this command database received 3349 SQL requests! Much of them are as follows:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;article_id&quot;</span> <span class="o">=</span> <span class="mi">2319</span> <span class="k">AND</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">67</span><span class="p">));</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2319</span><span class="p">,</span> <span class="mi">67</span><span class="p">)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="p">)</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="p">(</span><span class="ss">&quot;article_id&quot;</span><span class="p">,</span> <span class="ss">&quot;tag_id&quot;</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2319</span><span class="p">,</span> <span class="mi">67</span><span class="p">)</span> <span class="n">RETURNING</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2319</span><span class="p">,</span> <span class="mi">67</span><span class="p">)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_tag&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="o">=</span> <span class="s1">&#39;fugiat&#39;</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;fugiat&#39;</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;article_id&quot;</span> <span class="o">=</span> <span class="mi">2319</span> <span class="k">AND</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">68</span><span class="p">));</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2319</span><span class="p">,</span> <span class="mi">68</span><span class="p">)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="p">)</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="p">(</span><span class="ss">&quot;article_id&quot;</span><span class="p">,</span> <span class="ss">&quot;tag_id&quot;</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2319</span><span class="p">,</span> <span class="mi">68</span><span class="p">)</span> <span class="n">RETURNING</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2319</span><span class="p">,</span> <span class="mi">68</span><span class="p">)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_tag&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="o">=</span> <span class="s1">&#39;repellat&#39;</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;repellat&#39;</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;article_id&quot;</span> <span class="o">=</span> <span class="mi">2319</span> <span class="k">AND</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">58</span><span class="p">));</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2319</span><span class="p">,</span> <span class="mi">58</span><span class="p">)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="p">)</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="p">(</span><span class="ss">&quot;article_id&quot;</span><span class="p">,</span> <span class="ss">&quot;tag_id&quot;</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2319</span><span class="p">,</span> <span class="mi">58</span><span class="p">)</span> <span class="n">RETURNING</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2319</span><span class="p">,</span> <span class="mi">58</span>
</pre></div>


<p>Adding each tag to the article is performed with separated request. We can improve this command by invoking <code>article.tags.add</code>
method with all tags for a current article:</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_import_article</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">article_data</span><span class="p">):</span>
        <span class="c1"># ...</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]:</span>
            <span class="n">tag_instance</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_instance</span><span class="p">)</span>
        <span class="n">article</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">tags</span><span class="p">)</span>
</pre></div>


<p>This version sends only 1834 requests, almost 2 times fewer.</p>
<h3>Mass update</h3>
<p>After data import, we decided, that we need to disallow commenting on old articles (created before 2012). I added
the <code>comments_on</code> boolean field to the <code>Article</code> model. Now, we need to set its values:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>
<span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">created_at__year__lt</span><span class="o">=</span><span class="mi">2012</span><span class="p">):</span>
    <span class="n">article</span><span class="o">.</span><span class="n">comments_on</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">queries</span><span class="p">))</span>
</pre></div>


<p>This code generates 179 requests like following:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="p">)</span> <span class="k">UPDATE</span> <span class="ss">&quot;blog_article&quot;</span> <span class="k">SET</span> <span class="ss">&quot;title&quot;</span> <span class="o">=</span> <span class="s1">&#39;Saepe eius facere magni et eligendi minima sint.&#39;</span><span class="p">,</span> <span class="ss">&quot;content&quot;</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="ss">&quot;created_at&quot;</span> <span class="o">=</span> <span class="s1">&#39;1992-03-01&#39;</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span> <span class="ss">&quot;author_id&quot;</span> <span class="o">=</span> <span class="mi">730</span><span class="p">,</span> <span class="ss">&quot;comments_on&quot;</span> <span class="o">=</span> <span class="k">false</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">3507</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Saepe eius facere magni et eligendi minima sint.&#39;</span><span class="p">,</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">.</span><span class="nb">date</span><span class="p">(</span><span class="mi">1992</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">730</span><span class="p">,</span> <span class="k">False</span><span class="p">,</span> <span class="mi">3507</span><span class="p">)</span>
</pre></div>


<p>This code generates an individual request for each article older than 2012. Moreover, this code rewrites all fields of the article.
This can lead to a race condition if someone else has changed the article in between <code>SELECT</code> and <code>UPDATE</code> responses.</p>
<p>Instead, we can use <code>update</code> method of <code>QuerySet</code> instance:</p>
<div class="highlight"><pre><span></span><span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">created_at__year__lt</span><span class="o">=</span><span class="mi">2012</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">comments_on</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>


<p>This code generates just one SQL request:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">004</span><span class="p">)</span> <span class="k">UPDATE</span> <span class="ss">&quot;blog_article&quot;</span> <span class="k">SET</span> <span class="ss">&quot;comments_on&quot;</span> <span class="o">=</span> <span class="k">false</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span> <span class="o">&lt;</span> <span class="s1">&#39;2012-01-01&#39;</span><span class="p">::</span><span class="nb">date</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="k">False</span><span class="p">,</span> <span class="n">datetime</span><span class="p">.</span><span class="nb">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>


<p>If field update involves complex logic, that can't be performed by single <code>UPDATE</code> request, you can compute field values
in Python code and then use one of the following option:</p>
<div class="highlight"><pre><span></span><span class="n">Model</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">computed_value</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="n">instance</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">computed_value</span>
<span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">update_fields</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;fields&#39;</span><span class="p">,))</span>
</pre></div>


<p>But this options also suffers from race conditions.</p>
<h3>Mass delete</h3>
<p>Now, we need to remove all articles with tag <code>minus</code>:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>
<span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s1">&#39;minus&#39;</span><span class="p">):</span>
    <span class="n">article</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">queries</span><span class="p">))</span>
</pre></div>


<p>This code generates 93 requests as follows:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="p">)</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;article_id&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">3510</span><span class="p">);</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">3510</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="p">)</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">3510</span><span class="p">);</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">3510</span><span class="p">,)</span>
</pre></div>


<p>At first, this code removes the connection between article and tag. After that, the article itself is deleted. We can perform
this in less amount of <code>requests</code> with <code>delete</code> method of <code>QuerySet</code> instance:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>
<span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s1">&#39;minus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">queries</span><span class="p">))</span>
</pre></div>


<p>This code perform the same with only 3 requests to database:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">004</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;title&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;content&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;author_id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;comments_on&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;article_id&quot;</span><span class="p">)</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;blog_tag&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span> <span class="o">=</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">)</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="o">=</span> <span class="s1">&#39;minus&#39;</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;minus&#39;</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">002</span><span class="p">)</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;article_id&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">3713</span><span class="p">,</span> <span class="mi">3717</span><span class="p">,</span> <span class="mi">3722</span><span class="p">,</span> <span class="p">...);</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">3713</span><span class="p">,</span> <span class="mi">3717</span><span class="p">,</span> <span class="mi">3722</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">3713</span><span class="p">,</span> <span class="mi">3717</span><span class="p">,</span> <span class="p">...);</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">3713</span><span class="p">,</span> <span class="mi">3717</span><span class="p">,</span> <span class="mi">3722</span><span class="p">,</span> <span class="p">...)</span><span class="o">``</span><span class="k">sql</span>
</pre></div>


<p>At the beginning ids of all articles, marked with <code>minus</code> tag, is selected. Then the second request removes all connections
between this articles and tags. At last the articles itself is deleted.</p>
<h2>Iterator</h2>
<p>Let's pretend that we need to export articles to CSV file. This is the command to perform export:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>

    <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Export articles to csv&#39;</span>

    <span class="n">EXPORT_FILE_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;articles_export.csv&#39;</span><span class="p">)</span>
    <span class="n">COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;comments_on&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EXPORT_FILE_PATH</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">export_file</span><span class="p">:</span>
            <span class="n">articles_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="n">articles_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COLUMNS</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">articles_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLUMNS</span><span class="p">])</span>
</pre></div>


<p>For testing purpose, I generated around 100Mb of articles and load them to DB. After that, I run CSV export command with
<a href="https://pypi.python.org/pypi/memory_profiler">memory profiler</a>.</p>
<div class="highlight"><pre><span></span>mprof run python manage.py export_articles
mprof plot
</pre></div>


<p>As a result, I received the following graph of memory consumption:</p>
<p><img alt="export articles profiling" src="/media/2017/6/export_articles_without_iterator.png"></p>
<p>Command utilizes ~250Mb of memory because <code>QuerySet</code> receives all articles from DB at once and caches it to the memory
in order to use it in next accesses to <code>QuerySet</code>. You can reduce memory consumption through the use of <code>iterator</code> method.
This method allows to get query results one by one (with the <a href="http://initd.org/psycopg/docs/cursor.html">server-side cursor</a>)
and also it disables caching.</p>
<div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
<span class="c1"># ...</span>
</pre></div>


<p>This is the result of running the updated command in the memory profiler:</p>
<p><img alt="export articles profiling" src="/media/2017/6/export_articles_with_iterator.png"></p>
<p>Now the command utilizes only 50Mb of memory. Also, the pleasant side-effect is that memory utilization almost constant
for any amount of articles. Those are results for ~200Mb of articles (without and with the <code>iterator</code>):</p>
<p><img alt="huge export articles profiling" src="/media/2017/6/export_articles_huge_before_and_after.png"></p>
<h2>Foreign keys</h2>
<p>Now we have to add Django admin action to make a copy of the article: </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clone_article</span><span class="p">(</span><span class="n">modeladmin</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">queryset</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">modeladmin</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;You could clone only one article at a time.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">origin_article</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">cloned_article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;{} (COPY)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">origin_article</span><span class="o">.</span><span class="n">title</span><span class="p">),</span>
        <span class="n">content</span><span class="o">=</span><span class="n">origin_article</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">origin_article</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
        <span class="n">author</span><span class="o">=</span><span class="n">origin_article</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
        <span class="n">comments_on</span><span class="o">=</span><span class="n">origin_article</span><span class="o">.</span><span class="n">comments_on</span><span class="p">)</span>
    <span class="n">cloned_article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">cloned_article</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">origin_article</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">modeladmin</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article successfully cloned&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">messages</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span>
<span class="n">clone_article</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Clone article&#39;</span>
</pre></div>


<p>SQL logs:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;__count&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">31582</span><span class="p">);</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">31582</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;title&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;content&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;author_id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;comments_on&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">31582</span><span class="p">)</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span> <span class="k">DESC</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">31582</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;email&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;bio&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_author&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">2156</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2156</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;blog_article&quot;</span> <span class="p">(</span><span class="ss">&quot;title&quot;</span><span class="p">,</span> <span class="ss">&quot;content&quot;</span><span class="p">,</span> <span class="ss">&quot;created_at&quot;</span><span class="p">,</span> <span class="ss">&quot;author_id&quot;</span><span class="p">,</span> <span class="ss">&quot;comments_on&quot;</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;Explicabo maiores nobis cum vel fugit. (COPY)&#39;</span><span class="p">,</span> <span class="p">...</span>
</pre></div>


<p>Author data is fetched for some reason, but we don't need anything about author besides its id (that already in the article as
a foreign key). To fix this you need to refer directly to foreign key through <code>origin_article.author_id</code>.
I rewrote cloned object population as follows:</p>
<div class="highlight"><pre><span></span><span class="n">cloned_article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;{} (COPY)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">origin_article</span><span class="o">.</span><span class="n">title</span><span class="p">),</span>
    <span class="n">content</span><span class="o">=</span><span class="n">origin_article</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
    <span class="n">created_at</span><span class="o">=</span><span class="n">origin_article</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
    <span class="n">author_id</span><span class="o">=</span><span class="n">origin_article</span><span class="o">.</span><span class="n">author_id</span><span class="p">,</span>
    <span class="n">comments_on</span><span class="o">=</span><span class="n">origin_article</span><span class="o">.</span><span class="n">comments_on</span><span class="p">)</span>
</pre></div>


<p>And there is no author related request in logs.</p>
<h2>Retrieving of related objects</h2>
<p>It's time to make our articles publicly available. I will begin with simple articles list page. Let's build view:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ArticlesListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;blog/articles_list.html&#39;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;articles&#39;</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>


<p>There is information about an article, author, and tags in the template:</p>
<div class="highlight"><pre><span></span><span class="x">&lt;article&gt;</span>
<span class="x">    &lt;h2&gt;</span><span class="cp">{{</span> <span class="nv">article.title</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span>
<span class="x">    &lt;time&gt;</span><span class="cp">{{</span> <span class="nv">article.created_at</span> <span class="cp">}}</span><span class="x">&lt;/time&gt;</span>
<span class="x">    &lt;p&gt;Author: </span><span class="cp">{{</span> <span class="nv">article.author.username</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">    &lt;p&gt;Tags:</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">tag</span> <span class="k">in</span> <span class="nv">article.tags.all</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        </span><span class="cp">{{</span> <span class="nv">tag</span> <span class="cp">}}{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span><span class="x">, </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;/article&gt;</span>
</pre></div>


<p>DDT shows us that this page generates 45 SQL request as follows:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">002</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;title&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;content&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;author_id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;comments_on&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article&quot;</span> <span class="k">LIMIT</span> <span class="mi">20</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">()</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;email&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;bio&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_author&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">2043</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2043</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_tag&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span><span class="p">)</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;article_id&quot;</span> <span class="o">=</span> <span class="mi">20425</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">20425</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;email&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;bio&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_author&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">2043</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2043</span><span class="p">,)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_tag&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span><span class="p">)</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;article_id&quot;</span> <span class="o">=</span> <span class="mi">20426</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">20426</span><span class="p">,)</span>
</pre></div>


<p>Primarily we receive all articles (with considering of pagination). Then author and tags are obtained for each article apart.
Our goal is to force Django to get this related data in less amount of database requests. Let's begin with authors. To
make <code>QuerySet</code> retrieve related data by foreign keys we need to use the <code>select_related</code> method. I updated the <code>queryset</code>
in view as follows:</p>
<div class="highlight"><pre><span></span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span>
</pre></div>


<p>After this tuning DDT shows us that amount of SQL requests is reduced to 25. That's because data about articles and
corresponding authors now fetches by single SQL request with <code>JOIN</code>:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">004</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;title&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;content&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;author_id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;comments_on&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;email&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;bio&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;blog_author&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;author_id&quot;</span> <span class="o">=</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">21</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">()</span>
</pre></div>


<p>The <code>select_realted</code> method works only with foreign keys in the current model. To reduce an amount of requests when you fetch
multiple related objects (like tags in our example) we need to use the <code>prefetch_related</code> method. The updated <code>queryset</code>
looks like this:</p>
<div class="highlight"><pre><span></span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span>
</pre></div>


<p>Now DDT shows only 7 requests. Only 2 of them are responsible for displaying articles list:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">002</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;title&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;content&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;author_id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;comments_on&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;email&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;bio&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_article&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;blog_author&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;blog_article&quot;</span><span class="p">.</span><span class="ss">&quot;author_id&quot;</span> <span class="o">=</span> <span class="ss">&quot;blog_author&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">20</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="p">()</span>
<span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span> <span class="k">SELECT</span> <span class="p">(</span><span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;article_id&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;_prefetch_related_val_article_id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;blog_tag&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;blog_article_tags&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;blog_tag&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span><span class="p">)</span> <span class="k">WHERE</span> <span class="ss">&quot;blog_article_tags&quot;</span><span class="p">.</span><span class="ss">&quot;article_id&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">16352</span><span class="p">,</span> <span class="mi">16353</span><span class="p">,</span> <span class="mi">16354</span><span class="p">,</span> <span class="mi">16355</span><span class="p">,</span> <span class="mi">16356</span><span class="p">,</span> <span class="mi">16357</span><span class="p">,</span> <span class="mi">16358</span><span class="p">,</span> <span class="mi">16359</span><span class="p">,</span> <span class="mi">16360</span><span class="p">,</span> <span class="mi">16361</span><span class="p">,</span> <span class="mi">16362</span><span class="p">,</span> <span class="mi">16363</span><span class="p">,</span> <span class="mi">16344</span><span class="p">,</span> <span class="mi">16345</span><span class="p">,</span> <span class="mi">16346</span><span class="p">,</span> <span class="mi">16347</span><span class="p">,</span> <span class="mi">16348</span><span class="p">,</span> <span class="mi">16349</span><span class="p">,</span> <span class="mi">16350</span><span class="p">,</span> <span class="mi">16351</span><span class="p">);</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">16352</span><span class="p">,</span> <span class="mi">16353</span><span class="p">,</span> <span class="mi">16354</span><span class="p">,</span> <span class="mi">16355</span><span class="p">,</span> <span class="mi">16356</span><span class="p">,</span> <span class="mi">16357</span><span class="p">,</span> <span class="mi">16358</span><span class="p">,</span> <span class="mi">16359</span><span class="p">,</span> <span class="mi">16360</span><span class="p">,</span> <span class="mi">16361</span><span class="p">,</span> <span class="mi">16362</span><span class="p">,</span> <span class="mi">16363</span><span class="p">,</span> <span class="mi">16344</span><span class="p">,</span> <span class="mi">16345</span><span class="p">,</span> <span class="mi">16346</span><span class="p">,</span> <span class="mi">16347</span><span class="p">,</span> <span class="mi">16348</span><span class="p">,</span> <span class="mi">16349</span><span class="p">,</span> <span class="mi">16350</span><span class="p">,</span> <span class="mi">16351</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>You must use <code>select_related</code> to retrieve objects by a foreign key in the current model. To retrieve M2M objects or objects
from other models which has foreign keys to current one you should use <code>prefetch_related</code>.</p>
<p>Also, you can use <code>prefetch_related</code> to fetch related objects of arbitrary nesting levels.</p>
<p><code>Tag.objects.all().prefetch_related('article_set__author')</code></p>
<p>This code will fetch all articles and corresponding authors with tag.</p>
</blockquote>
<h2>Defer fields retrieving</h2>
<p>If you look closer to the previous example you can see that we retrieve more fields than we needed.
This is the result of the request in DDT:</p>
<p><img alt="SQL query result for articles list" src="/media/2017/6/sql-queries-results.png"></p>
<p>This SQL request retrieves all fields of article and author, including a potentially huge text of an article. You can
significantly reduce an amount of transferring data with <code>defer</code> method. This method defers retrieving of given fields.
In case if some code tries to access deferred field it will be retrieved in separate SQL request on-demand. Let's add
<code>defer</code> invocation to the <code>queryset</code>:</p>
<div class="highlight"><pre><span></span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;comments_on&#39;</span><span class="p">)</span>
</pre></div>


<p>Now Django don't retrieve unneeded fields and this reduces the time of request processing (before and after <code>defer</code>):</p>
<p><img alt="DDT - SQL speedup after defer" src="/media/2017/6/sql-speedup-defer.png"></p>
<p>But this request still fetches more data than we need. We receive all author info. Easier would be to give a list
of fields that we actually need. We can use the <code>only</code> method for this, it will defer all fields except specified:</p>
<div class="highlight"><pre><span></span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span>
    <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;author__username&#39;</span><span class="p">,</span> <span class="s1">&#39;tags__name&#39;</span><span class="p">)</span>
</pre></div>


<p>As a result, we receive only needed data:</p>
<p><img alt="DDT - SQL after only" src="/media/2017/6/sql-after-only.png"></p>
<p><code>defer</code> and <code>only</code> perform the same task - limiting fetched fields in requests. Differences between this methods are:</p>
<ul>
<li><code>defer</code> defers only specified fields,</li>
<li><code>only</code> defers all fields except specified.</li>
</ul>
<h2>Database indexes</h2>
<p>Now we decided to create an author page, that should be accessible by URL like this: <code>/authors/&lt;username&gt;</code>.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">author_page_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Author</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;blog/author.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">))</span>
</pre></div>


<p>This code works pretty fast on a small amount of data. But if an amount of data is big and continues to grow, performance
inevitably will fall. That's because to find a row by <code>username</code> field DBMS has to scan the entire table. A better
approach is to use database indexes. They allow DBMS to search data much faster. To add an index to the field you should
add the <code>db_index=True</code> argument to the corresponding model field. After that, you should make and execute the migration.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>


<p>Let's now compare performance before and after we added the index on a database with 100K of authors:</p>
<p>Without index:</p>
<p><img alt="select by username without index" src="/media/2017/6/ddt-select-by-username-without-index.png"></p>
<p>With index:</p>
<p><img alt="select by username with index" src="/media/2017/6/ddt-select-by-username-with-index.png"></p>
<p>The request is faster for 16x times now!</p>
<blockquote>
<p>Indexes are useful not only for data filtration. They speed up sorting as well. Also, many of DBMS provide
multi-field indexes to speed up filtration and sorting by several fields. You should read a documentation to your
DBMS for details.</p>
</blockquote>
<h2>len(qs) vs qs.count</h2>
<p>For some reason, we decided to display a count of authors on the articles list page. Let's update view:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ArticlesListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>

    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;authors_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">context</span>
</pre></div>


<p>This code generates following SQL request:</p>
<p><img alt="DDT - len(qs)" src="/media/2017/6/ddt-authors-len-queryset.png"></p>
<p>On the screenshot, you can see that we fetch all authors from a database. Therefore counting is performed in view by the
Python code. The optimal approach is to retrieve only one number from a database - count of authors. We can use <code>count</code> method
for this:</p>
<div class="highlight"><pre><span></span>        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;authors_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>


<p>This is a request generated by the updated code:</p>
<p><img alt="DDT - len(qs)" src="/media/2017/6/ddt-authors-count.png"></p>
<p>Now Django generated a much more optimal request for our task.</p>
<h2>count vs exists</h2>
<p>We need to display a link to authors articles on the author page, but only if he has any. One possible solution is to retrieve
a count of articles and compare if it more than 0. Like this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">author_page_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Author</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
    <span class="n">show_articles_link</span> <span class="o">=</span> <span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">articles</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;blog/author.html&#39;</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">,</span> <span class="n">show_articles_link</span><span class="o">=</span><span class="n">show_articles_link</span><span class="p">))</span>
</pre></div>


<p>But if we have a huge amount of articles this code will work slowly. Since we don't need to know the exact amount of articles,
we could use <code>exists</code> method, that checks if <code>QuerySet</code> has at least one result.</p>
<div class="highlight"><pre><span></span>    <span class="c1"># ...</span>
    <span class="n">show_articles_link</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="n">articles</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="c1"># ...</span>
</pre></div>


<p>Let's compare performance on a large amount of articles (~10K):</p>
<p><img alt="DDT - exists vs count" src="/media/2017/6/ddt-exists-vs-count.png"></p>
<p>So, we reach the goal with requests that 10x faster.</p>
<h2>QuerySet laziness</h2>
<p>Now we wanted the authors to compete with each over. We will add a rating of top-20 authors by articles count.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ArticlesListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># ...</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;top_authors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-articles_count&#39;</span><span class="p">))[:</span><span class="mi">20</span><span class="p">]</span>
        <span class="c1"># ...</span>
</pre></div>


<p>Here we retrieve sorted by articles count list of all authors and slice first 20 from it. <code>articles</code> count in this example
is a denormalized field with a count of articles of the current user. In a real project, you probably should add signals to
update this field on data changes.</p>
<p>I think you already understand that this approach is not ideal. DDT confirms this:</p>
<p><img alt="DDT - get top authors slice" src="/media/2017/6/ddt-top-authors-list.png"></p>
<p>Of course, we need to receive from database already truncated list of authors. You need to understand that <code>QuerySet</code>
tries to defer hitting database as far as possible. <code>QuerySet</code> hits database in this cases:</p>
<ul>
<li>iteration (i.e., <code>for obj in Model.objects.all():</code>),</li>
<li>slicing with specified step (i.e., <code>Model.objects.all()[::2]</code>),</li>
<li>call of <code>len</code> (i.e., <code>len(Model.objects.all())</code>,</li>
<li>call of <code>list</code> (i.e., <code>list(Model.objects.all())</code>,</li>
<li>call of <code>bool</code> (i.e., <code>bool(Model.objects.all())</code>,</li>
<li>serialization with <a href="https://docs.python.org/3/library/pickle.html">pickle</a>.</li>
</ul>
<p>Therefore when we call <code>list</code> we forced <code>QuerySet</code> to hit database and return list of objects. Slicing was performed on list,
not <code>QuerySet</code>. To limit authors in a database we should apply slicing to <code>QuerySet</code> itself:</p>
<div class="highlight"><pre><span></span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;top_authors&#39;</span><span class="p">]</span> <span class="o">=</span>\
    <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-articles_count&#39;</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span>
</pre></div>


<p><img alt="DDT - get top authors slice on queryset" src="/media/2017/6/ddt-top-authors-qs-slice.png"></p>
<p>As you can see, a size of fetch is limited in the request: <code>...LIMIT 20</code>. Also, DDT shows that <code>QuerySet</code> defers hitting
the DB unto template rendering.</p>
  </div>
</section>
        <footer id="contentinfo" class="body">
            (c) 2010-2017
        </footer><!-- /#contentinfo -->
</body>
</html>