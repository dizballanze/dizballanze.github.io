<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="HandheldFriendly" content="true">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Node.JS + MySQL</title>
    <link rel="stylesheet" href="/theme/css/native.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/main.css" />
    <link href="https://fonts.googleapis.com/css?family=PT+Serif&amp;subset=cyrillic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=PT+Mono&amp;subset=cyrillic" rel="stylesheet">
    <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-20497524-1', 'auto');
      ga('send', 'pageview');
    </script>
	
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  "HTML-CSS": {
  styles: {
  ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
  },
  tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']],processEscapes: true}
  });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body id="index" class="home">
        <header id="banner" class="body">
            <h1><a href="/">Tech blog by @dizballanze <strong></strong></a></h1>
            <div id="langs">
                <a href="/">En</a>
                <a href="/ru/">Ru</a>
            </div>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/about-me/">About</a></li>
            <li><a href="https://wbtech.pro/">WB–Tech</a></li>
            <li><a href="https://debugmail.io/">DebugMail</a></li>
        </ul>
        </nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="/drafts/nodejs-mysql-ru.html" rel="bookmark"
         title="Permalink to Node.JS + MySQL">Node.JS + MySQL</a></h2>
    <time class="published" datetime="2011-03-28T18:47:00+04:00"><nobr>28 мар 2011</nobr></time>
  </header>
  <div class="entry-content">
    <p><img alt="Mysql + Node.js" src="/media/2011/03/Mysql-300x76.png" title="Mysql + Node.js"/></p>
<p>В последнем проекте появилась необходимость
организации работы Node.JS с MySQL. Для создания данного взаимодействия
существует несколько модулей, я решил использовать <strong>node-mysql</strong>, т.к.
он предоставляет все необходимые мне функции.</p>
<h2 id="ustanovka-node-mysql">Установка node-mysql</h2>
<p>Для установки воспользуемся git:</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span> ~/.node_libraries
git clone git://github.com/felixge/node-mysql.git mysql
</pre></div>
<p>После этого вы можете без проблем использовать данный модуль в вашей
работе.</p>
<h2 id="ustanovka-soedineniia">Установка соединения</h2>
<p>Перед началом выполнения запросов к БД необходимо выполнить подключение
к серверу MySQL. Рассмотрим как сделать это при помощи модуля node-mysql
в node.js:</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Client</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">).</span><span class="nx">Client</span><span class="p">,</span>
<span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">();</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="s1">'root'</span><span class="p">;</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</pre></div>
<p>Первые две строки отвечают за подключение модуля и создания
объекта-клиента. Далее задаются параметры аутентификации и вызывается
метод connect. После этого если вы корректно указали пару логин-пароль,
то будет установлено соединение. Последняя строка соответственно
завершает соединение с сервером.</p>
<h3 id="otstuplenie">Отступление</h3>
<p>Для того что-бы наш MySQL клиент мог передать данные аутентификации
необходимо чтобы node.js был скомпилирован с поддержкой ssl, иначе при
попытке установления соединения он будет жутко ругатся из-за то что не
сможет зашифровать пароль. Для корректной компиляции node.js с
поддержкой ssl в Debian вам потребуется пакет libssl-dev</p>
<h2 id="vypolnenie-zaprosov_2">Выполнение запросов</h2>
<p>Сначала создадим тестовую базу данных и таблицу в ней:</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">DATABASE</span>  <span class="o">`</span><span class="n">test_nodejs</span><span class="o">`</span> <span class="k">DEFAULT</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span><span class="p">;</span>
<span class="n">USE</span> <span class="n">test_nodejs</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="o">`</span><span class="n">test_nodejs</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">test</span><span class="o">`</span> <span class="p">(</span>
<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">,</span>
<span class="o">`</span><span class="n">some_text_data</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span> <span class="mi">255</span> <span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="o">`</span><span class="n">some_date</span><span class="o">`</span> <span class="nb">DATE</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">MYISAM</span> <span class="p">;</span>
</pre></div>
<p>Теперь приступим непосредственно к выполнению запросов.</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Client</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">).</span><span class="nx">Client</span><span class="p">,</span>
<span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">();</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="s1">'root'</span><span class="p">;</span> <span class="c1">// Устанавливаем логин</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="s1">'password'</span><span class="p">;</span> <span class="c1">// Устанавливаем пароль</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span> <span class="c1">// Устанавливаем соединение</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'USE test_nodejs'</span><span class="p">);</span> <span class="c1">// Выполняем запрос на выбор БД</span>
<span class="c1">//  Запрос на вставку</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO test VALUES (NULL, \'Test\', \'03-28-2011\')'</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span> 
    <span class="c1">// Запрос на выборку</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SELECT * FROM test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">fields</span><span class="p">){</span>
        <span class="c1">// Если возникла ошибка выбрасываем исключение</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">){</span>
            <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// выводим результат</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">fields</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="c1">// Завершаем соединение</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p>Для тех кто уже достаточно освоился в асинхронном программировании
данный код не вызовет трудностей. Для выполнения запросов используется
метод клиента query, который кроме самого запроса принимает
callback-функцию с параметрами error (ошибка, если возникла), result
(массив объектов результата запроса), fields (описание полей из
множества полей результата). В результате выполнения вышеприведённого
кода получим:</p>
<div class="highlight"><pre><span></span>node test.js 
{ id: 
   { length: 45,
     received: 45,
     number: 2,
     type: 4,
     catalog: 'def',
     db: 'test_nodejs',
     table: 'test',
     originalTable: 'test',
     name: 'id',
     originalName: 'id',
     charsetNumber: 63,
     fieldLength: 20,
     fieldType: 8,
     flags: 16899,
     decimals: 0 },
  some_text_data: 
   { length: 69,
     received: 69,
     number: 3,
     type: 4,
     catalog: 'def',
     db: 'test_nodejs',
     table: 'test',
     originalTable: 'test',
     name: 'some_text_data',
     originalName: 'some_text_data',
     charsetNumber: 192,
     fieldLength: 765,
     fieldType: 253,
     flags: 4097,
     decimals: 0 },
  some_date: 
   { length: 59,
     received: 59,
     number: 4,
     type: 4,
     catalog: 'def',
     db: 'test_nodejs',
     table: 'test',
     originalTable: 'test',
     name: 'some_date',
     originalName: 'some_date',
     charsetNumber: 63,
     fieldLength: 10,
     fieldType: 10,
     flags: 4225,
     decimals: 0 } }
[ { id: 1,
    some_text_data: 'Test',
    some_date: Invalid Date } ]
</pre></div>
<p>На этом всё. Если есть какие-либо вопросы по данной теме, задавайте их в
комментариях ниже, постараюсь ответить.</p>
  </div>
</section>
        <footer id="contentinfo" class="body">
            (c) 2010-2018
        </footer><!-- /#contentinfo -->
</body>
</html>