<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="HandheldFriendly" content="true">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Используем сессию express в socket.io</title>
    <link rel="stylesheet" href="/theme/css/native.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/main.css" />
    <link href="https://fonts.googleapis.com/css?family=PT+Serif&amp;subset=cyrillic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=PT+Mono&amp;subset=cyrillic" rel="stylesheet">
    <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-20497524-1', 'auto');
      ga('send', 'pageview');
    </script>
	
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  "HTML-CSS": {
  styles: {
  ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
  },
  tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']],processEscapes: true}
  });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body id="index" class="home">
        <header id="banner" class="body">
            <h1><a href="/">Tech blog by @dizballanze <strong></strong></a></h1>
            <div id="langs">
                <a href="/">En</a>
                <a href="/ru/">Ru</a>
            </div>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/about-me/">Author</a></li>
            <li><a href="https://wbtech.pro/">WB–Tech</a></li>
            <li><a href="https://debugmail.io/">DebugMail</a></li>
        </ul>
        </nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="/drafts/ispolzuem-sessiiu-express-v-socketio-ru.html" rel="bookmark"
         title="Permalink to Используем сессию express в socket.io">Используем сессию express в socket.io</a></h2>
    <time class="published" datetime="2013-04-19T13:33:00+04:00"><nobr>19 апр 2013</nobr></time>
  </header>
  <div class="entry-content">
    <p>При разработке приложения с использованием socket.io + express часто возникает задача использования сессии express в socket.io. Рассмотрим, как можно решить эту задачу.</p>
<h2 id="ispolzuemye-pakety">Используемые пакеты</h2>
<p>Нам нужно установить несколько пакетов, которые пригодятся для решения поставленной задачи (предполагается что express и soket.io уже установлены):</p>
<p><code>bash
npm install cookie express-session-mongo</code></p>
<ul>
<li><code>cookie</code> - модуль для удобного парсинга cookie</li>
<li><code>express-session-mongo</code> - back-end для хранения сессий express в MongoDB</li>
</ul>
<h2 id="nastraivaem-express">Настраиваем express</h2>
<p>Настроим сессии в express:</p>
<p>```javascript
var DB = {
  'ip': '127.0.0.1',
  'port': 27017,
  'db': 'test'
}</p>
<p>var MongoSessionStore = require('express-session-mongo')
  , session_storage = new MongoSessionStore(DB);</p>
<p>var app = express();</p>
<p>app.configure(function(){</p>
<p>/<em> .... </em>/</p>
<p>app.use(express.cookieParser('secret'));
  app.use(express.session({
    store: session_storage,
    secret: 'secret',
    key: 'sid'
  }));
});
```</p>
<p>В данном примере мы используем MongoDB для хранения сессий, но данный приём будет работать и для других хранилищ.</p>
<h2 id="poluchaem-sessionnye-dannye-v-soketio">Получаем сессионные данные в soket.io</h2>
<p>```javascript
// Запускаем web-сервер
var server = http.createServer(app).listen(app.get('port'), function(){
  console.log("Express server listening on port " + app.get('port'));
});</p>
<p>var io = socketio.listen(server);</p>
<p>// Настраиваем socket.io
io.configure(function() {</p>
<p>// Аутентификация пользователей
  io.set('authorization', function (data, accept) {
    // Проверяем переданы ли cookie
    if (!data.headers.cookie) 
      return accept('No cookie transmitted.', false);</p>
<pre><code>// Парсим cookie
data.cookie = cookie.parse(data.headers.cookie);

// Получаем идентификатор сессии
var sid = data.cookie['sid'];

if (!sid) {
  accept(null, false);
}

sid = sid.substr(2).split('.');
sid = sid[0];
data.sessionID = sid;

// Добавляем метод для чтения сессии
// в handshakeData
data.getSession = function(cb) {
  // Запрашиваем сессию из хранилища
  session_storage.get(sid, function(err, session) {
    if (err || !session) {
      console.log(err);
      accept(err, false);
      return;
    }
    cb(err, session);
  });
}
accept(null, true);
</code></pre>
<p>});
});</p>
<p>// Пример использования
io.sockets.on('connection', function(socket) {
  socket.join('chat');</p>
<p>socket.on('message', function(data) {
    socket.handshake.getSession(function(err, session) {
      data['user'] = session.name || 'guest';
      io.sockets.in('chat').emit('message', data);
    });
  });
});
```</p>
<p>Для чтения сессии в обработчиках socket.io нужно использовать <code>socket.handshake.getSession</code>.</p>
<h2 id="zakliuchenie">Заключение</h2>
<p>Стоит отметить, что если socket.io у вас слушает другой хост/порт, отличный от express, то необходимо предусмотреть другой способ передачи идентификатора сессии.</p>
<p>Полный пример можно посмотреть на <a href="https://github.com/dizballanze/express-socketio-session-example/">GitHub</a>.</p>
  </div>
</section>
        <footer id="contentinfo" class="body">
            (c) 2010-2017
        </footer><!-- /#contentinfo -->
</body>
</html>